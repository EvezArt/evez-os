services:
  redis:
    image: redis:7
    ports: ["6379:6379"]

  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: game
    ports: ["5432:5432"]

  nats:
    image: nats:2
    ports: ["4222:4222", "8222:8222"]

  otel:
    image: otel/opentelemetry-collector:0.96.0
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./infra/otel-collector.yaml:/etc/otelcol/config.yaml:ro
    ports: ["4317:4317","4318:4318"]

  apigw:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./services/apigw:/app
      - ./spine:/spine
    environment:
      EVENT_SPINE: /spine/EVENT_SPINE.jsonl
    command: sh -lc "npm install && npm run dev"
    ports: ["8000:8000"]
    depends_on: [redis, postgres, nats]

  game-server:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./services/game-server:/app
      - ./spine:/spine
    environment:
      EVENT_SPINE: /spine/EVENT_SPINE.jsonl
    command: sh -lc "npm install && npm run dev"
    ports: ["9001:9001"]
    depends_on: [nats]

  agent:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ./services/agent:/app
      - ./spine:/spine
      - ./schemas:/schemas
      - ./tools:/app/tools
    environment:
      EVENT_SPINE: /spine/EVENT_SPINE.jsonl
      FSC_SCHEMA: /schemas/fsc_schema.json
      PYTHONPATH: /app
    command: sh -lc "pip install -r requirements.txt && uvicorn app:app --host 0.0.0.0 --port 7000"
    ports: ["7000:7000"]
